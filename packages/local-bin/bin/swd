#!/usr/bin/env bash
# swd: download a random wallpaper from wallhaven.cc with filters
# Usage:
#   swd [options]
# Options:
#   -C, --colors HEX[,HEX...]   dominant colors (e.g. 424153 or 424153,ffffff)
#   -a, --atleast WxH           minimum resolution (default: 3840x2160)
#   -p, --purity STR            purity flags (SFW=100, Sketchy=010, Both=110)
#   -c, --categories STR        categories (General=100, Anime=010, People=001)
#   -r, --ratios LIST           aspect ratios (e.g. 16x9,21x9)
#   -s, --sorting MODE          latest|views|toplist|favorites|random
#   -o, --order ORDER           asc|desc (default: desc)
#   -l, --location DIR          download directory (default: $XDG_PICTURES_DIR/wl or ~/pic/wl)
#   -k, --apikey KEY            Wallhaven API key (optional)
#   -h, --help                  show this help


IFS=$'\n\t'

if [[ "$1" == "-h" || "$1" == "--help" || "$1" == "help" ]]; then
  sed -n '2,14p' "$0" | sed 's/^# \{0,1\}//'; exit 0
fi
die(){ printf 'swd: %s\n' "$*" >&2; :; }
need(){ command -v "$1" >/dev/null 2>&1 || printf 'swd: missing dependency: %s\n' "$1" >&2; }
need curl
need jq
# TODO: create swd for unsplash
location="${XDG_PICTURES_DIR:-$HOME/pic}/wl"
atleast="3840x2160"
purity="100"
categories="100"
order="desc"
ratios="16x9"
sorting="random"
colors=""
apikey="${WALLHAVEN_API_KEY:-}"

# Set the dominant colors of the image
# All           = Do not include for all
# #660000 #990000 #cc0000 #cc3333 #ea4c88 #993399
# #663399 #333399 #0066cc #0099cc #66cccc #77cc33
# #669900 #336600 #666600 #999900 #cccc33 #cccc33
# #cccc33 #ff9900 #ff6600 #cc6633 #996633 #663300
# #000000 #999999 #cccccc #ffffff #424153
# colors="424153"
# Set the site address
site="wallhaven.cc"

# Translate long options to short and parse via getopts
_args=()
while (($#)); do
  case "$1" in
    --help) _args+=("-h"); shift ;;
    --colors) _args+=("-C" "$2"); shift 2 ;;
    --atleast) _args+=("-a" "$2"); shift 2 ;;
    --purity) _args+=("-p" "$2"); shift 2 ;;
    --categories) _args+=("-c" "$2"); shift 2 ;;
    --ratios) _args+=("-r" "$2"); shift 2 ;;
    --sorting) _args+=("-s" "$2"); shift 2 ;;
    --order) _args+=("-o" "$2"); shift 2 ;;
    --location) _args+=("-l" "$2"); shift 2 ;;
    --apikey) _args+=("-k" "$2"); shift 2 ;;
    --*) die "unknown option: $1" ;;
    *) _args+=("$1"); shift ;;
  esac
done
set -- "${_args[@]}"

while getopts ":C:a:p:c:r:s:o:l:k:h" opt; do
  case "$opt" in
    C) colors="$OPTARG" ;;
    a) atleast="$OPTARG" ;;
    p) purity="$OPTARG" ;;
    c) categories="$OPTARG" ;;
    r) ratios="$OPTARG" ;;
    s) sorting="$OPTARG" ;;
    o) order="$OPTARG" ;;
    l) location="$OPTARG" ;;
    k) apikey="$OPTARG" ;;
    h) sed -n '2,20p' "$0" | sed 's/^# \{0,1\}//'; exit 0 ;;
    :) die "option -$OPTARG requires an argument" ;;
    \?) die "unknown option: -$OPTARG" ;;
  esac
done
shift $((OPTIND-1))

# Build API URL instead of scraping HTML
api_url="https://$site/api/v1/search?"
[[ -n "$categories" ]] && api_url+="categories=$categories"
[[ -n "$purity" ]] && api_url+="&purity=$purity"
[[ -n "$order" ]] && api_url+="&order=$order"
[[ -n "$colors" ]] && api_url+="&colors=$colors"
[[ -n "$ratios" ]] && api_url+="&ratios=$ratios"
[[ -n "$atleast" ]] && api_url+="&atleast=$atleast"
api_url+="&page=$(("$RANDOM" % 30 + 1))"

case "$sorting" in
  "latest") api_url+="&sorting=date_added" ;;
  "views") api_url+="&sorting=views" ;;
  "toplist") api_url+="&sorting=toplist" ;;
  "favorites") api_url+="&sorting=favorites" ;;
  *) api_url+="&sorting=random" ;;
esac

# Read JSON and pick random wallpaper path (.data[].path)
[[ -n "$colors" ]] && colors="${colors//#/}"
[[ -n "$apikey" ]] && api_url+="&apikey=$apikey"
json="$(curl -fsS --retry 3 --retry-delay 1 "$api_url")" || die "failed to query API"
mapfile -t img_paths < <(jq -r '.data[]?.path' <<< "$json")
if [[ ${#img_paths[@]} -eq 0 ]]; then
  die "no wallpapers found for the given filters"
fi
rand_img="${img_paths[$RANDOM % ${#img_paths[@]}]}"
mkdir -p -- "$location"
wallpaper="$location/${rand_img##*/}"
curl -fsS --retry 3 --retry-delay 1 -o "$wallpaper" "$rand_img" >/dev/null || die "failed to download image"
printf '%s\n' "$wallpaper"
