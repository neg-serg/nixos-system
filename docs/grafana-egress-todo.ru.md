# Grafana: возможные источники внешнего трафика (TODO)

Цель: собрать в одном месте причины исходящих соединений Grafana и договориться, что из этого
блокируем, а что — разрешаем осознанно.

Текущее состояние (хост telfir)

- Отключено: аналитика, проверка обновлений, новостная лента, внешние снапшоты, альфа‑плагины.
- Отключён Gravatar (аватары извне).
- Ограничен исходящий трафик самой службы Grafana системно:
  - `IPAddressDeny=any`, `IPAddressAllow=127.0.0.0/8 ::1/128` — сервис не сможет ходить в интернет.
- Пароль админа — через SOPS‑секрет и `$__file{...}`.

Симптомы

- «Grafana гоняет траффик» — может быть как серверный выход (сама служба), так и клиентский трафик
  браузера при открытии UI.

Возможные источники исходящих соединений

1. Браузер (клиентская сторона)

- Гео‑карты/тайлы (Map/Geomap) с публичных tile‑серверов.
- Шрифты/иконки/изображения из внешних CDN, если панель/тема на них ссылается.
- Встроенные панели с URL ресурсов вне LAN.

2. Сервис Grafana (серверная сторона)

- Плагин‑маркет (каталог, иконки, подписи) и авто‑обновления плагинов.
- Вебхуки алертинга (Slack/Telegram/…): при строгой блокировке egress не доставятся.
- Datasource’ы, направленные на внешние URL (JSON/CSV/Infinity/Prometheus/Loki в облаке).
- OAuth‑логин к внешним провайдерам (Google/GitHub и т. п.).
- Рендеринг изображений или панелей, пытающийся подтянуть внешний ресурс (редко).

Что уже предотвращено настройками

- `analytics.reporting_enabled=false`, `check_for_updates=false`, `news_feed_enabled=false`,
  `snapshots.external_enabled=false`.
- `plugins.disable_install_api=true` (UI установки плагинов выключен), `users.allow_gravatar=false`.
- Системный запрет egress через `IPAddressDeny/Allow` (оставлен только loopback).

TODO (решить и/или задокументировать)

- [ ] Оставляем ли egress сервиса полностью закрытым? Если нет — описать минимальный allow‑лист
  IP/подсетей под конкретные нужды (например, вебхуки алертинга) и где его задавать.
- [ ] Алертинг: либо используем Alertmanager (локально), либо делаем явные исключения для нужных
  внешних получателей.
- [ ] Панели с картами/внешними ресурсами: добавить в README пометку, что это клиентский трафик
  браузера и он не управляется настройками сервиса.
- [ ] CSP/Headers через Caddy: при необходимости добавить строгую CSP, чтобы в UI не утекали внешние
  скрипты/шрифты/изображения.
- [ ] Плагины: определить политику установки — только через Nix/деривации или разово с последующей
  «заморозкой» каталога (tmpfiles очищает плагины на активации).
- [ ] Документировать, как временно снять egress‑блокировку для локальной отладки (временный
  `IPAddressAllow`/перезапуск).
- [ ] Проверить, нет ли datasource’ов, указывающих за пределы localhost/LAN.

Проверка/диагностика

- Сетевые ограничения юнита: `systemctl show -p IPAddressDeny -p IPAddressAllow grafana.service`
- Логи сервиса: `journalctl -u grafana -b`
- Сокеты/соединения процесса: `sudo ss -tpn | rg grafana`
- Входящий трафик (Caddy): `sudo tail -f /var/lib/caddy/logs/grafana_access.log`

Примечания

- Даже при полной блокировке egress у сервиса в браузере пользователя могут быть внешние запросы —
  это нормальное поведение для некоторых панелей (например, гео‑тайлы). Если нежелательно —
  используйте локальные тайл‑сервера или панели без внешних ресурсов.
