# План миграции Home Manager (standalone flake) в модуль NixOS

## Контрольный чек-лист (фаза 2)

- [x] Home Manager подключён как модуль NixOS (`modules/home-manager`) и использует те же
  flake‑входы, что и система.
- [x] Документация обновлена: `README.md/ru.md` в поддереве `home/` описывают единую репозиторию под
  `/etc/nixos` и рекомендуют применять конфигурацию через
  `sudo nixos-rebuild switch --flake /etc/nixos#<host>`.
- [x] Служебные скрипты и Just‑таргеты теперь по
  умолчанию смотрят на `/etc/nixos/home`, чтобы не требовать отдельного клонa.
- [x] Остаточные ссылки на standalone‑режим `home-manager switch` удалены либо помечены как требующие
  ручного режима.
- [ ] После полного удаления standalone‑режима удалить поддерево `home/justfile` либо оставить
  только dev‑режим с отдельным предупреждением (см. раздел «Проверки после миграции» ниже).

## Подготовка

1. **Обновление и синхронизация flake‑входов:** Обновите входы `nixpkgs` и `home‑manager` в обоих
   флейках (`nixos‑home` и `nixos‑system`) через `nix flake update` и убедитесь, что Home Manager
   использует ту же ветку `nixpkgs`, что и система (например, `release‑23.05` или `release‑23.11`).
   В `flake.nix` основного конфигурационного репозитория добавьте
   `inputs.home-manager.inputs.nixpkgs.follows = "nixpkgs";`, чтобы избежать несовместимостей между
   версиями Home Manager и NixOS【9†L63-L68】【1†L195-L203】.

1. **Резервное копирование и фиксация состояния:** Сохраните актуальное состояние обоих репозиториев
   (dotfiles и system) в отдельных коммитах. Это позволит безболезненно откатиться к работающей
   конфигурации, если что-то пойдёт не так.

1. **Проверка прав sudo:** Модульная интеграция подразумевает запуск `nixos‑rebuild` от имени
   `root`. Убедитесь, что ваш пользователь входит в группу `wheel` или имеет доступ к `sudo`;
   выполните `sudo -v` для предварительной проверки. Без sudo вы не сможете собрать и применить
   конфигурацию【18†L131-L137】.

1. **Подготовка секретов и ключей:** Если старая Home‑конфигурация использовала шифрованные секреты
   (sops‑nix, agenix или другое), перенесите файлы `secrets/`, `.sops.yaml` и ключи в новый
   репозиторий `nixos‑system`. Подключите модуль `sops‑nix` как вход флейка и импортируйте его
   модуль NixOS. Проверьте, что у root‑пользователя есть доступ к ключам для расшифровки.

1. **Планирование времени простоя:** Переключение системы и пользовательских настроек может
   потребовать перезагрузку или выход из рабочей сессии. Запланируйте миграцию на время, когда
   краткий downtime допустим.

1. **Отключение standalone Home Manager:** Перестаньте использовать отдельные команды
   `home-manager switch` и связанные таймеры. После переноса управлять профилем пользователя будет
   `nixos‑rebuild`, использование старого метода приведёт к конфликтам поколений【21†L193-L197】.

## Изменения в конфигурации

1. **Подключение Home Manager как модуля NixOS:** В `flake.nix` системы объявите вход `home-manager`
   и укажите ему актуальную ветку. В определении `nixosConfigurations.<host>` добавьте модуль
   Home Manager в список модулей:

   ```nix
   modules = [
     inputs.home-manager.nixosModules.home-manager  # импорт модуля HM
     ./hardware-configuration.nix
     ./configuration.nix
     # ... другие модули
   ];
   ```

   В non‑flake конфигурации аналогично укажите `imports = [ <home-manager/nixos> ];` в
   `configuration.nix`【21†L172-L180】.

1. **Перенос home-конфигурации пользователя:** Внутри `nixosConfigurations.<host>` определите
   `home-manager.users.<имя_пользователя> = { ... };`. Скопируйте туда содержимое вашего бывшего
   `home.nix` (или импортируйте файл). Укажите обязательные параметры:

   - `home.username` и `home.homeDirectory` при необходимости.
   - `home.stateVersion` — версия, соответствующая первоначальной установке Home Manager (например,
     "23.05")【18†L116-L123】.
   - `imports = [ ... ]` — список ваших домашних модулей.
   - При желании добавьте `programs.home-manager.enable = true;` для установки CLI Home Manager,
     если вам нужен доступ к команде `home-manager`【1†L71-L74】【21†L178-L185】.

### Применение конфигурации после объединения

- Основной путь: `sudo nixos-rebuild switch --flake /etc/nixos#<host>`. Home Manager подключён как
  модуль, поэтому пользовательский профиль активируется вместе с системой без отдельного
  `home-manager switch`.
- Быстрая проверка без переключения:
  `nix build .#nixosConfigurations.<host>.config.home-manager.users.<user>.activationPackage`.
- Для дев‑режима на отдельных машинах без NixOS допустим
  `home-manager switch --flake /etc/nixos/home#<profile>`, но на основных машинах команда должна
  быть отключена сразу после миграции (см. «Очистка»).

1. **Единый набор входов flake:** Перенесите дополнительные inputs (оверлеи, сторонние пакеты) из
   `nixos-home` в `nixos-system` и привяжите их к общему `nixpkgs`. Это обеспечит сборку всех
   пакетов из одного источника и исключит несовместимости.

1. **Общие модули и фичи:** Если у вас есть файлы с общими опциями (флаги `features.*`, shared
   modules), перенесите их в `nixos-system` и подключите как модули NixOS или в секции
   `home-manager.users.<name>.imports`. Это предотвратит дублирование настроек.

## Перенос локальных модулей, секретов и XDG‑конвенций

- **Локальные home‑модули:** Скопируйте каталоги `modules/`, `packages/` и любые собственные
  Nix‑модули из `nixos-home` в новый репозиторий (например, `home-modules/`). Подключите их через
  `home-manager.users.<name>.imports`, соблюдая относительные пути. Убедитесь, что ссылки на файлы
  внутри модулей актуальны.

- **Секреты:** Перенесите все зашифрованные секреты и соответствующие определения. Используйте
  модуль `sops-nix` и определяйте секреты либо в NixOS (`sops.secrets.<name>`), либо в Home Manager
  (`home.secrets.<name>`), в зависимости от ситуации. Проверьте расшифровку секретов сборкой
  соответствующих дериваций.

- **XDG‑помощники и `lib.neg`:** Если использовались кастомные функции для XDG и systemd, перенесите
  библиотеку `lib.neg` в новый репозиторий и подключите её. В противном случае можно воспользоваться
  стандартными опциями Home Manager `xdg.configFile` и `xdg.dataFile` для размещения файлов в
  `$XDG_CONFIG_HOME`【18†L179-L187】. Сравните пути: `home.file ".config/app/file"` и
  `xdg.configFile."app/file"` создают файл в `~/.config/app/file`, но кастомные функции могли
  работать иначе. Убедитесь, что размещение файлов после миграции совпадает.

- **Systemd user units:** Проверьте, что ваши пользовательские сервисы перенесены. Home Manager
  позволяет объявлять их через `systemd.user.services`; если ранее использовались функции
  `lib.neg.systemdUser.mkUnitFromPresets`, перенесите их или замените на стандартный синтаксис
  `WantedBy = [ "default.target" ];` и др.

## Валидация новой конфигурации

1. **Проверка flake:** Выполните `nix flake check`, чтобы убедиться в корректности синтаксиса и
   зависимостей.

1. **Сборка профиля пользователя:** Проверьте, что профиль Home Manager собирается без ошибок:

   ```sh
   nix build .#nixosConfigurations.<host>.config.home-manager.users.<user>.activationPackage
   ```

   Ошибки сборки укажут на отсутствующие файлы, опечатки или несовместимые опции.

1. **Пробный запуск:** Выполните `sudo nixos-rebuild dry-run --flake .#<host>`. Эта команда покажет,
   какие действия будут предприняты, но не применит их. Исправьте выявленные проблемы.

1. **Тестовое применение:** Запустите `sudo nixos-rebuild test --flake .#<host>`. Это применит
   изменения без обновления загрузочной конфигурации. Убедитесь, что в выводе нет ошибок активации
   home‑конфигурации и что службы запускаются корректно. При необходимости перезагрузитесь или
   выйдите из сессии, чтобы применились новые настройки.

1. **Финальное переключение:** Если тест прошёл успешно, примените конфигурацию окончательно:
   `sudo nixos-rebuild switch --flake .#<host>`. Эта команда установит новую генерацию системы.

1. **Откат:** При возникновении проблем используйте `sudo nixos-rebuild switch --rollback` или
   выберите предыдущую генерацию в загрузчике. Помните, что откат восстанавливает и system, и
   home‑конфигурацию; отдельного отката home‑конфига больше нет【21†L193-L197】.

## Потенциальные проблемы и способы их избежать

- **Несовместимость версий NixOS и Home Manager:** Если Home Manager использует другую ветку
  nixpkgs, могут возникать ошибки типа «attribute missing» или «unknown option»【1†L195-L203】.
  Убедитесь, что Home Manager следует за системным `nixpkgs` через `follows`. При необходимости
  обновите обе части до актуального релиза.

- **Конфликты опций:** Одни и те же параметры могут задаваться и в NixOS, и в Home Manager.
  Преднамеренно разделите систему и пользовательские настройки. Используйте `mkForce` или уберите
  дубликаты, если получаете сообщения о множественном определении.

- **Отсутствие CLI Home Manager:** По умолчанию в модульной интеграции утилита `home-manager` не
  устанавливается; изменения применяются через `nixos-rebuild`. Если нужен CLI, включите
  `programs.home-manager.enable = true;`【21†L178-L185】. В противном случае можно запускать команды
  через `nix run home-manager/master -- ...`.

- **Гонки активации:** Некоторые user‑сервисы могут стартовать до завершения активации Home Manager,
  если вы обновляете конфигурацию в запущенной графической сессии. После `nixos-rebuild`
  рекомендуется выйти из сессии и войти снова, либо добавить опцию `activateOnBoot = true` (если
  доступна), чтобы применять home‑конфиг при старте системы. Внимательно следите за выводом
  `nixos-rebuild` и журналами.

- **Различия путей:** При переходе от кастомных XDG‑функций к стандартным
  `home.file`/`xdg.configFile` возможны изменения путей; проверяйте, что файлы лежат там, где
  ожидаете. Сравните содержимое `~/.config` и домашнего каталога до и после миграции и устраните
  дублирование.

- **Необходимость sudo и увеличенное время сборки:** Теперь каждое изменение dotfiles потребует
  `sudo nixos-rebuild`. Собирайтесь планировать изменения партиями, чтобы не запускать rebuild
  слишком часто. Используйте `nixos-rebuild build` для быстрой проверки, прежде чем переключать
  систему.

- **Конфликтующие истории генераций:** Интегрированная установка Home Manager ведёт историю в
  `/nix/var/nix/profiles/per-user/<user>/home-manager`. Удалите старую историю standalone‑HM
  (`~/.config/home-manager`) и перестаньте запускать старый `home-manager switch`, чтобы избежать
  путаницы.

## Пост‑мониторинг и smoke‑тесты

После успешного переключения проведите комплексную проверку:

- **Systemd user units:** Просмотрите список юнитов `systemctl --user list-units --state=loaded` и
  убедитесь, что все ожидаемые сервисы активны. Проверьте статус кастомных сервисов
  (`systemctl --user status <service>`), чтобы убедиться, что они работают корректно.

- **Локальные обёртки и скрипты:** Выполните скрипты, расположенные в `~/bin` или `~/.local/bin`,
  например, ваш `rofi`‑wrapper или dev‑скрипты. Убедитесь, что они присутствуют в `$PATH` и
  запускаются без ошибок.

- **Секреты:** Запустите приложения, зависящие от секретов (парольные менеджеры, токены API,
  GPG‑агенты) и убедитесь, что секреты расшифровываются. Проверьте права файлов с секретами и их
  наличие.

- **Конфигурационные файлы (dotfiles):** Откройте терминал и убедитесь, что shell‑настройки (bash,
  zsh, fish) подхватываются. Проверьте `git config`, `tmux`, `neovim/helix`, конфигурации Hyprland.
  Запустите Rofi или другие графические меню и убедитесь, что они используют правильный конфиг.

- **Пакеты в пользовательском профиле:** С помощью
  `nix profile list --profile /nix/var/nix/profiles/per-user/<user>/home-manager` или `nix-env -q`
  убедитесь, что перечисленные в `home.packages` приложения установлены и доступны.

- **Переменные окружения:** Выполните `printenv` и убедитесь, что переменные, установленные через
  `home.sessionVariables` или NixOS (`environment.variables`), имеют ожидаемые значения.

- **Ребут и вход:** Перезагрузите систему и войдите в сессию, чтобы убедиться, что все user‑юниты
  запускаются автоматически. Проверьте логи `journalctl --user -p err -b` на предмет ошибок.

- **Очистка старых артефактов:** После нескольких дней успешной работы удалите старый репозиторий
  `nixos-home` и каталоги `~/.config/home-manager`, чтобы избежать случайного использования старых
  настроек.

Выполнив эти шаги, вы получите единую точку управления для системы и пользовательского окружения,
сохранив все настройки Home Manager и избежав распространённых проблем при миграции на модуль
NixOS【18†L131-L137】.
