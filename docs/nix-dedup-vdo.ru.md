# Бенчмарк дедупликации /nix (Borg + модель VDO)

Здесь описано, как мы оценили потенциальную экономию места от блочной
дедупликации и сжатия для `/nix`.  Документ также служит инструкцией, как
повторить эксперимент после заметного роста стора.

## Предпосылки

- **VDO** (Virtual Data Optimizer) — модуль device-mapper: он делит поток на
  блоки по 4 КиБ, хеширует их и хранит каждую уникальную подпоследовательность
  ровно один раз.  Повторяющиеся блоки ссылаются на те же физические данные, а
  оставшиеся «уникальные» блоки прогоняются через встроенный LZ4‑подобный
  компрессор.  То есть мы получаем «дедуп + компрессию» на блочном уровне.
- **Borg** — дедуплицирующий бэкап‑инструмент.  Если задать
  `--chunker-params fixed,4096`, он будет резать файлы на те же блоки по
  4 КиБ, считать хеш и складывать только уникальные куски.  Флаг
  `--compression none|lz4` позволяет смоделировать режим «только дедуп»
  или «дедуп + сжатие».  В данном эксперименте Borg играёт роль измерительного
  инструмента, а не резервного копирования.

Такие замеры помогают понять, стоит ли включать VDO/btrfs/ZFS дедуп на диске и
на сколько места реально можно рассчитывать.

## Процедура

1. Создать временный репозиторий Borg на большом разделе (в примере —
   `/zero/caches/nix-dedupe-borg`).

2. Снять статистику с фиксированными блоками по 4 КиБ: сначала без сжатия,
   затем с LZ4.

   ```bash
   # Только дедупликация (аналог VDO без компрессора)
   borg init --encryption=none /zero/caches/nix-dedupe-borg
   borg create --stats --json \
     --compression none \
     --chunker-params fixed,4096 \
     /zero/caches/nix-dedupe-borg::nix-$(date +%Y%m%d%H%M%S) /nix

   # Удалить репозиторий и повторить с LZ4
   borg delete /zero/caches/nix-dedupe-borg
   borg init --encryption=none /zero/caches/nix-dedupe-borg
   borg create --stats --json \
     --compression lz4 \
     --chunker-params fixed,4096 \
     /zero/caches/nix-dedupe-borg::nix-$(date +%Y%m%d%H%M%S) /nix
   ```

   Примечания:

   - Нужен пользователь с доступом на чтение `/nix`.  Пара lock-файлов под
     `/nix/var/nix/{builds,gc.lock,db,temproots,userpool}` остаются недоступны
     без root (размер буквально несколько килобайт) — на итог не влияют.
   - Один прогон длится ~11–14 минут и создаёт репозиторий объёмом 65–120 ГиБ.
     После снятия метрик удалите его (`borg delete …`), чтобы не держать мусор.

3. Преобразовать поля `original_size`, `deduplicated_size`,
   `compressed_size` из JSON в GiB и проценты.

## Итоги на ноябрь 2025

| Прогон | Параметры Borg | Исходный объём | Уникальные данные | Размер репозитория | Экономия |
| --- | --- | --- | --- | --- | --- |
| Только дедуп | `--compression none --chunker-params fixed,4096` | 176 302 987 003 Б (≈164.19 ГиБ) | 122 781 869 773 Б (≈114.35 ГиБ) | 122 781 869 773 Б | ≈49.85 ГиБ (≈30.4 %) |
| Дедуп + LZ4 | `--compression lz4 --chunker-params fixed,4096` | тот же | 67 008 764 776 Б (≈62.41 ГиБ) | 89 704 670 309 Б до дедуп → 67 008 764 776 Б после | ≈101.79 ГиБ (≈62.0 %) |

Выводы:

- Чистая блочная дедупликация способна вернуть примерно треть занятого объёма
  `/nix`.
- Добавление лёгкого LZ4‑сжатия (как это делает VDO) почти удваивает выигрыш,
  потому что большинство store‑путей неплохо компрессуются.

## Зачем повторять

- **Планирование ёмкости**: показывает верхнюю границу выгоды, прежде чем
  включать VDO и тратить ресурсы на онлайн‑дедуп.
- **Динамика**: повторные запуски подсказывают, как меняется коэффициент
  дедупликации по мере роста стора — проще угадывать, когда расширять диски.
- **Проверка инструментов**: убеждаемся, что Borg установлен, а в
  `/zero/caches` достаточно места для подобных аудитов.

После записи цифр очистите репозиторий:

```bash
yes YES | borg delete /zero/caches/nix-dedupe-borg
```

Если понадобится новый снимок — заново вызовите `borg init` и повторите
процедуру.  Временные данные всегда складываем в `/zero/caches`, чтобы не
захламлять корневой раздел.
